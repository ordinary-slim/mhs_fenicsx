# GEOMETRY  (all lengths in millimetres)
radius            : &radius 0.1
half_radius       : &half_radius 0.05
substrate_depth   : 2.0
width             : 1.0
adim_pad_width: 5 # * radius
fine_el_size      : 0.05
coarse_el_size    : 0.4
layer_thickness   : &layer_thickness 0.05
hatch_spacing     : *layer_thickness
pre_recoating_dwell_time : 9.0 # s
post_recoating_dwell_time : 1.0 # s
final_dwelling_time : 5.0 # s
num_layers        : 2
num_buffer_layers : 4

dt               : 1.0     # placeholder
max_timesteps    : -1
isSteady         : False
writepos: True

source_terms :
  - type            : gaussian3d
    initial_position: &p0 [-5000.0, 0.0, 0.0]   # mm, placeholder
    initial_speed   : &speed [1000.0, 0.0, 0.0]  # mm / s
    radius          : *radius
    power           : &power 70 # W
    path            : &path "Path.gcode"
  - type            : gaussian3d
    initial_position: *p0
    initial_speed   : *speed
    radius          : *radius
    power           : 0.0
    path            : *path

environment_temperature : &environment_temperature 25 # C
bb_tree_padding         : 1.0E-08 # mm

# MATERIAL PROPERTIES (Mind the mm!)
material_powder : {
  density        : &density_powder [[20, 2.8E-06], [1625, 3.8E-06]], # kg / mm3 
  conductivity   : [[20, 1.7E-03], [1000, 6.5E-03], [1650, 24.0E-03], [2000, 27.5E-03]], # (C, W / mm / K)
  specific_heat  : &specific_heat 560, # J / kg / K
  phase_change   : {
    latent_heat : &latent_heat 350.0E+03,
    solidus_temperature   : &solidus_temperature 1600.0,  # C
    liquidus_temperature  : &liquidus_temperature 1650.0, # C
    melts_to              : "metal",
  }
}
material_metal : {
  density : &density_metal [[20, 4.42E-06], [1625, 3.8E-06]], # kg / mm3
  conductivity : [[20, 7.7E-03], [1000, 17.5E-03], [1650, 24.0E-03], [2000, 27.5E-03]], # (C, W / mm / K)
  specific_heat : *specific_heat,
  phase_change : {
    latent_heat : *latent_heat,
    solidus_temperature : *solidus_temperature,
    liquidus_temperature : *liquidus_temperature,
  }
}
smoothing_cte_phase_change : 0.25
convection_coeff : 2.5E-05 # W / mm2 / K
# radiation_coeff -> emissivity * steffan_boltzman
# steffan_boltzman = 5.67E-8 W / m2 / K4 = 5.67E-14 W / mm2 / K4
# emissivity = 0.3
radiation_coeff: 2.835E-14 # W / mm2 / K4
# LINEAR SOLVER OPTIONS
petsc_opts_micro: {
  "ksp_error_if_not_converged" : "true",
  "ksp_type" : "gmres",
  "ksp_atol" : 1e-10,
  "ksp_rtol" : 1e-10,
  "pc_type" : "hypre",
}
petsc_opts_macro: {
  "ksp_error_if_not_converged" : "true",
  "ksp_type" : "gmres",
  "ksp_atol" : 1e-10,
  "ksp_rtol" : 1e-10,
  "pc_type" : "hypre",
  "snes_linesearch_type" : "basic",
  "snes_rtol" : 1e-8,
  "snes_atol" : 1e-8,
  #"pc_type" : "lu",
  #"pc_factor_mat_solver_type" : "superlu_dist",
}
petsc_opts_moving: {
  "ksp_error_if_not_converged" : "true",
  "ksp_type" : "gmres",
  "ksp_atol" : 1e-10,
  "ksp_rtol" : 1e-10,
  "pc_type" : "hypre",
  "snes_linesearch_type" : "basic",
  "snes_rtol" : 1e-8,
  "snes_atol" : 1e-8,
}
#"newtonls" "newtontr" "newtontrdc" "python" "nrichardson" "ksponly"
#"ksptransposeonly" "vinewtonrsls" "vinewtonssls" "ngmres" "qn" "shell" "ngs"
#"ncg" "fas" "ms" "nasm" "anderson" "aspin" "composite" "patch" "newtonal"
petsc_opts_mono_robin: {
  #"snes_type" : "anderson",
  #"snes_linesearch_monitor" : "",
  "snes_linesearch_type" : "bt",
  "snes_linesearch_order" : 1,
  #"snes_linesearch_alpha": 1e-4,
  "snes_linesearch_minlambda" : 1e-2,
  "snes_linesearch_maxstep" : 1e8,
  "snes_linesearch_max_it" : 5,

  "snes_max_it" : 30,
  "ksp_atol" : 1e-09,
  "ksp_rtol" : 1e-09,
  #"snes_stol" : 1e-3,
  #"snes_linesearch_type": "none",
  "ksp_error_if_not_converged" : "true",
  "pc_type" : "fieldsplit",
  "pc_fieldsplit_type" : "additive",
  "ksp_type" : "gmres",
  #"ksp_view" : 100,
  #"pc_fieldsplit_schur_factorization_type" : "full",
  #"fieldsplit_0_pc_type" : "lu",
  #"fieldsplit_0_pc_factor_mat_solver_type" : "superlu_dist",
  #"fieldsplit_1_pc_type" : "lu",
  #"fieldsplit_1_pc_factor_mat_solver_type" : "superlu_dist"
   #"pc_type" : "lu",
   #"pc_factor_mat_solver_type" : "mumps",
}
petsc_opts_macro_chimera: {
  "snes_max_it" : 30,
  "ksp_atol" : 1e-13,
  "ksp_rtol" : 1e-13,
  "snes_linesearch_max_it" : 15,
  "ksp_error_if_not_converged" : "true",
  "ksp_type" : "gmres",
  "pc_type" : "fieldsplit",
}

# SUBSTEPPING PARAMETERS
substepping_parameters: {
  micro_adim_dt: 0.5,
  macro_adim_dt: 5.0,
  dwelling_adim_dt : 0.5,
  final_dwelling_adim_dt: 0.1,
  cooling_adim_dt: 1.0,
  max_staggered_iters: 1,
  adim_lens: {
    back_pad : 3,
    front_pad : 3.5,
    side_pad : 3.5,
    top_pad : 1,
    bot_pad : 3,
  },
  predictor: {
    enabled :  True,
    source_term : 0,
  },
  writepos: False,
  only_writepos_macro: False,
  chimera_always_on: True,
  chimera_driver: {
    type: "staggered",
    gamma_coeff1 : 1.0,
    gamma_coeff2 : 1.0,
  },
  chimera_steadiness_workflow: {
    enabled: True,
    adim_dt_increment: 0.5,
    max_adim_dt: &max_adim_dt 2.0,
    reuse_last_dt : True,
  },
}
# CHIMERA PARAMS
supg: 1
scale_stabilization: 2.0
moving_domain_params : {
  shape : True,
  els_per_radius : -1, # placeholder
  max_adim_dt : *max_adim_dt,
  adim_front_len : 2.5,
  adim_side_len : 2.5,
  adim_bot_len : 2.5,
  adim_top_len : 0.0,
}
quadrature_metadata: {
  #quadrature_rule : "vertex",
  quadrature_degree : 4,
}
# PRINTER
printer: {
  type : 'LPBF',
  reuse_heated_els : False,
  layer_thickness : *layer_thickness,
  deposition_temperature : *environment_temperature
}
gamma_quadrature: {
  degree: 4,
}
